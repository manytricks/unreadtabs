<!DOCTYPE HTML>
<html>
	<head>
		<title>Unread Tabs</title>
		<meta charset="utf-8">
		<script type="text/javascript">

			// Copyright Â© 2013 Many Tricks (When in doubt, consider this MIT-licensed)

			var theApplication = safari.application;

			theApplication.addEventListener('contextmenu', function(theEvent) {
				var theURLs = theEvent.userInfo;
				if (theURLs) {
					var theNumberOfURLs = theURLs.length;
					if (theNumberOfURLs>0) {
						theEvent.contextMenu.appendContextMenuItem('com.manytricks.UnreadTabs.Open', ((theNumberOfURLs==1) ? 'Open Unread Post in New Tab' : 'Open ' + theNumberOfURLs + ' Unread Posts in New Tabs'));
					}
				}
			}, false);

			theApplication.addEventListener('command', function(theEvent) {
				if (theEvent.command=='com.manytricks.UnreadTabs.Open') {
					var theURLs = theEvent.userInfo;
					if (theURLs) {
						var theNumberOfURLs = theURLs.length;
						if (theNumberOfURLs>0) {
							var theWindow = safari.application.activeBrowserWindow;
							var theCurrentTab = theWindow.activeTab;
							var theSettings = safari.extension.settings;
							var theFocusSetting = theSettings.getItem('com.manytricks.UnreadTabs.Focus');
							var theNewTabLevel = ((theFocusSetting=='current') ? 'background' : 'foreground');
							if (theSettings.getItem('com.manytricks.UnreadTabs.Position')=='next') {
								var theTabs = theWindow.tabs;
								var theNumberOfTabs = theTabs.length;
								var theIndex = 1;
								var i;
								if (theNumberOfTabs>1) {
									for (i = 0; i<theNumberOfTabs; i++) {
										if (theTabs[i]===theCurrentTab) {
											theIndex = i + 1;
											break;
										}
									}
								}
								for (i = 0; i<theNumberOfURLs; i++) {
									theWindow.openTab(theNewTabLevel, theIndex++).url = theURLs[i];
								}
							} else {
								for (i = 0; i<theNumberOfURLs; i++) {
									theWindow.openTab(theNewTabLevel).url = theURLs[i];
								}
							}
							if (theFocusSetting=='close') {
								theCurrentTab.close();
							}
							return;
						}
					}
					alert('No new posts detected on this page');	// we should never get here
				}
			}, false);

		</script>
	</head>
	<body></body>
</html>
